<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Privacy Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-red-600 mb-8">üö® Notification Privacy Check</h1>
        
        <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-red-800 mb-4">‚ö†Ô∏è CRITICAL SECURITY ISSUE DETECTED</h2>
            <p class="text-red-700 mb-4">
                You reported that ALL customers are receiving notifications instead of just the specific customer. 
                This is a serious privacy and security issue that needs immediate investigation.
            </p>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üîç Investigation Tools</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Test User Email:</label>
                <input type="email" id="userEmail" value="bs@gmail.com" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                <button onclick="checkAllNotifications()" class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600">
                    Check ALL Notifications
                </button>
                <button onclick="checkUserNotifications()" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                    Check User Notifications
                </button>
                <button onclick="createTestNotification()" class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600">
                    Create Test Notification
                </button>
                <button onclick="checkDatabaseUsers()" class="bg-purple-500 text-white px-3 py-2 rounded text-sm hover:bg-purple-600">
                    Check Database Users
                </button>
                <button onclick="testAPIEndpoints()" class="bg-orange-500 text-white px-3 py-2 rounded text-sm hover:bg-orange-600">
                    Test API Endpoints
                </button>
                <button onclick="clearResults()" class="bg-gray-500 text-white px-3 py-2 rounded text-sm hover:bg-gray-600">
                    Clear Results
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üìã Investigation Results</h2>
            <pre id="results" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-96 whitespace-pre-wrap">
Click buttons above to investigate the privacy issue...
            </pre>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">üõ°Ô∏è Security Checklist</h2>
            <div class="space-y-4">
                <div class="border-l-4 border-red-500 pl-4">
                    <h3 class="font-semibold text-red-800">1. Check Database Isolation</h3>
                    <p class="text-sm text-gray-600">Verify that notifications are properly isolated by user_email</p>
                    <code class="block bg-gray-100 p-2 rounded text-xs mt-2">
SELECT user_email, COUNT(*) as notification_count 
FROM notifications 
GROUP BY user_email 
ORDER BY notification_count DESC;
                    </code>
                </div>
                
                <div class="border-l-4 border-orange-500 pl-4">
                    <h3 class="font-semibold text-orange-800">2. Check API Endpoints</h3>
                    <p class="text-sm text-gray-600">Verify that API endpoints only return notifications for the requesting user</p>
                    <ul class="text-xs text-gray-600 mt-2 list-disc list-inside">
                        <li>GET /api/notifications/user/{email} - Should only return notifications for that email</li>
                        <li>GET /api/notifications/user/{email}/count - Should only count notifications for that email</li>
                    </ul>
                </div>
                
                <div class="border-l-4 border-yellow-500 pl-4">
                    <h3 class="font-semibold text-yellow-800">3. Check Observer Pattern</h3>
                    <p class="text-sm text-gray-600">Verify that observers only notify the specific user</p>
                    <ul class="text-xs text-gray-600 mt-2 list-disc list-inside">
                        <li>WebSocket notifications should go to /user/{email}/notifications</li>
                        <li>Email notifications should only go to the specific user</li>
                    </ul>
                </div>
                
                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-semibold text-green-800">4. Check Frontend Filtering</h3>
                    <p class="text-sm text-gray-600">Verify that frontend only displays notifications for the logged-in user</p>
                    <ul class="text-xs text-gray-600 mt-2 list-disc list-inside">
                        <li>JavaScript should use the correct user email from URL parameters</li>
                        <li>API calls should include the correct user email</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let results = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            results += `[${timestamp}] ${message}\n`;
            document.getElementById('results').textContent = results;
        }
        
        function clearResults() {
            results = '';
            document.getElementById('results').textContent = 'Results cleared...';
        }
        
        function getUserEmail() {
            return document.getElementById('userEmail').value;
        }
        
        async function checkAllNotifications() {
            log('üîç Checking ALL notifications in database...');
            log('‚ö†Ô∏è This should show notifications for ALL users - this is normal for admin purposes');
            
            try {
                // This endpoint doesn't exist, but we can simulate it
                log('‚ùå No admin endpoint available to check all notifications');
                log('üí° Use the database directly: SELECT * FROM notifications ORDER BY created_at DESC;');
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }
        
        async function checkUserNotifications() {
            const userEmail = getUserEmail();
            log(`üîç Checking notifications for user: ${userEmail}`);
            
            try {
                const response = await fetch(`/api/notifications/user/${userEmail}`);
                log(`üì° API Response Status: ${response.status}`);
                
                if (response.ok) {
                    const notifications = await response.json();
                    log(`üìã Found ${notifications.length} notifications for ${userEmail}:`);
                    
                    if (notifications.length === 0) {
                        log('‚úÖ No notifications found - this is correct if user has no notifications');
                    } else {
                        notifications.forEach((notification, index) => {
                            log(`  ${index + 1}. ${notification.title} (${notification.type}) - User: ${notification.userEmail}`);
                            
                            // Check if notification belongs to the right user
                            if (notification.userEmail !== userEmail) {
                                log(`    üö® SECURITY ISSUE: Notification belongs to ${notification.userEmail}, not ${userEmail}!`);
                            } else {
                                log(`    ‚úÖ Notification correctly belongs to ${userEmail}`);
                            }
                        });
                    }
                } else {
                    log(`‚ùå Error: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }
        
        async function createTestNotification() {
            const userEmail = getUserEmail();
            log(`üîç Creating test notification for: ${userEmail}`);
            
            try {
                const response = await fetch('/api/notifications/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `userEmail=${userEmail}&title=Privacy Test&message=This notification should ONLY appear for ${userEmail}&type=SYSTEM&priority=URGENT`
                });
                
                log(`üì° API Response Status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Created notification with ID: ${data.notificationId}`);
                    log(`   User: ${data.userEmail}`);
                    log(`   Title: ${data.title}`);
                    
                    // Verify the notification was created for the right user
                    if (data.userEmail === userEmail) {
                        log(`‚úÖ Notification correctly created for ${userEmail}`);
                    } else {
                        log(`üö® SECURITY ISSUE: Notification created for ${data.userEmail}, not ${userEmail}!`);
                    }
                } else {
                    log(`‚ùå Error: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }
        
        async function checkDatabaseUsers() {
            log('üîç Checking what users have notifications in the database...');
            log('üí° Run this SQL query in your database:');
            log('');
            log('SELECT user_email, COUNT(*) as notification_count');
            log('FROM notifications');
            log('GROUP BY user_email');
            log('ORDER BY notification_count DESC;');
            log('');
            log('This will show you:');
            log('1. Which users have notifications');
            log('2. How many notifications each user has');
            log('3. If notifications are properly isolated by user');
        }
        
        async function testAPIEndpoints() {
            const userEmail = getUserEmail();
            log(`üîç Testing API endpoints for user: ${userEmail}`);
            
            // Test 1: Get notifications
            try {
                log('üì° Testing: GET /api/notifications/user/{email}');
                const response1 = await fetch(`/api/notifications/user/${userEmail}`);
                log(`   Status: ${response1.status}`);
                
                if (response1.ok) {
                    const notifications = await response1.json();
                    log(`   Found ${notifications.length} notifications`);
                    
                    // Check if all notifications belong to the right user
                    const wrongUserNotifications = notifications.filter(n => n.userEmail !== userEmail);
                    if (wrongUserNotifications.length > 0) {
                        log(`   üö® SECURITY ISSUE: ${wrongUserNotifications.length} notifications belong to other users!`);
                    } else {
                        log(`   ‚úÖ All notifications belong to ${userEmail}`);
                    }
                }
            } catch (error) {
                log(`   ‚ùå Error: ${error.message}`);
            }
            
            // Test 2: Get count
            try {
                log('üì° Testing: GET /api/notifications/user/{email}/count');
                const response2 = await fetch(`/api/notifications/user/${userEmail}/count`);
                log(`   Status: ${response2.status}`);
                
                if (response2.ok) {
                    const count = await response2.json();
                    log(`   Unread count: ${count}`);
                }
            } catch (error) {
                log(`   ‚ùå Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>

